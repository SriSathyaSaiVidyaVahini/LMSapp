name: Check APK Page Size

on:
  workflow_dispatch:

jobs:
  test-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # 1. Download artifact from another workflow run
      - name: Download apk artifact ZIP (authenticated, correct headers)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -L \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -o apk_artifact.zip \
            https://api.github.com/repos/SriSathyaSaiVidyaVahini/LMSapp/actions/artifacts/3437552163/zip
            # https://github.com/SriSathyaSaiVidyaVahini/LMSapp/actions/runs/15989916619/artifacts/3437552163



      - name: Unzip APK artifact
        run: |
          unzip -o apk_artifact.zip -d .
          ls -l
    
    
      - name: Check APK for 16KB Page Size Limit
        id: check_page_size
        run: |
          APK_PATH=$(find . -name "*.apk" | head -n 1)
    
          if [ -z "$APK_PATH" ]; then
            echo "Error: No APK file found."
            exit 1
          fi
    
          echo "Found APK at: $APK_PATH"
          echo "Checking APK for 16KB page size compliance..."
          
          # Unzip the APK to a temporary directory to inspect its contents
          unzip -q "$APK_PATH" -d extracted_apk
          
          echo "Checking shared object (.so) files for 16KB page size compliance..."
          
          set -e
          # Loop through all .so files found in the extracted APK
          for sofile in $(find extracted_apk/lib -name "*.so"); do
            echo "Checking $sofile"
            
            # Use readelf to get the ELF program headers, and grep for the page size
            PAGE_SIZE=$(readelf -l "$sofile" | grep "PAGE_SIZE" | awk '{print $NF}')
            
            if [[ "$PAGE_SIZE" -ne "16384" ]]; then
              echo "❌ Error: The file $sofile has a PAGE_SIZE of $PAGE_SIZE, which is not 16384."
              exit 1
            fi
            
            echo "✅ $sofile is compliant."
          done
          
          echo "All .so files checked and are compliant with the 16KB page size limit."
