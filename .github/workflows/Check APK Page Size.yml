name: Check APK Page Size

on:
  workflow_dispatch:

jobs:
  test-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # 1. Download artifact from another workflow run
      - name: Download apk artifact ZIP (authenticated, correct headers)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -L \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -o apk_artifact.zip \
            https://api.github.com/repos/SriSathyaSaiVidyaVahini/LMSapp/actions/artifacts/5185200200/zip
            # https://github.com/SriSathyaSaiVidyaVahini/LMSapp/actions/runs/21160778507/artifacts/5185200200



      - name: Unzip APK artifact
        run: |
          unzip -o apk_artifact.zip -d .
          ls -l
    
    
      - name: Check APK for 16KB Page Size Limit
        id: check_page_size
        run: |
          APK_PATH=$(find . -name "*.apk" | head -n 1)
    
          if [ -z "$APK_PATH" ]; then
            echo "Error: No APK file found."
            exit 1
          fi
    
          echo "Found APK at: $APK_PATH"
          echo "Checking APK for 16KB page size compliance..."

          sudo apt-get update
          sudo apt-get install -y binutils
          
          # Unzip the APK to a temporary directory to inspect its contents
          unzip -q "$APK_PATH" -d extracted_apk
          
          echo "Checking shared object (.so) files for 16KB page size compliance..."

          echo "üîç Checking arm64-v8a shared libraries for 16KB page compatibility..."

          FAILED=0

          for so in $(find extracted_apk/lib/arm64-v8a -name "*.so"); do
            echo ""
            echo "‚û°Ô∏è  $so"

            # Confirm architecture
            if ! readelf -h "$so" | grep -q "Machine:.*AArch64"; then
              echo "‚ö†Ô∏è  Skipping non-arm64 binary"
              continue
            fi

            # Check LOAD segment alignment
            BAD=$(readelf -l "$so" | \
                  awk '/LOAD/ { if (strtonum($NF) < 0x4000) print $NF }')

            if [ -n "$BAD" ]; then
              echo "‚ùå FAIL: LOAD segment alignment < 16KB"
              readelf -l "$so" | grep LOAD
              FAILED=1
            else
              echo "‚úÖ OK: All LOAD segments are ‚â• 16KB aligned"
            fi
          done

          if [ "$FAILED" -eq 1 ]; then
            echo ""
            echo "‚ùå One or more libraries are not 16KB page compatible"
            exit 1
          fi

          echo ""
          echo "üéâ All arm64-v8a native libraries are 16KB page compatible (Play-safe)"
